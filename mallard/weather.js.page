<page xmlns="http://projectmallard.org/1.0/"
    type="topic"
    id="weatherapp.js">

  <info>    
    <link type="guide" xref="index#js"/>    
    <desc> How to get information over the internet asynchronously so that your application will not halt if you have a sudden loss on connection to the internet. Asynchronous models will be presented through a weather showing application.
    </desc>    
    <revision pkgversion="0.1" version="0.1" date="2012-01-04" status="review"/>
    <credit type="author">
      <name>Susanna Huhtanen</name>
      <email>ihmis.suski@gmail.com</email>
    </credit>    
  </info>

  <title>Weather application with asynchronous calls</title>  
  <synopsis>
    <p>In this guide well construct a weather application using asynchronous calls. The weather information in this example is fetched from geonames.org and is using the ICAO codes to place your weather request. In this guide we weill go through the following parts:</p>
      
    <list>
      <item><p> planning ui</p></item>
      <item><p> weatherapp.js</p></item>
      <item><p> geonames.js </p></item>
      <item><p> Asynchronous calls</p></item>
      <item><p> Autotools</p></item>
    </list> 
      
    <p>To do and run all the code examples yourself, you need an editor to write code in, terminal and GNOME 3. or higher installed into your computer.</p>
  </synopsis>
    <section id ="planningUi">
  <p> Main window will only accept 1 widget, plan your structure accordingly(using Gtk.Box)</p>
  </section>
      <section id ="Asynhronous">
  <p> Structuring your application to be asynchronous rather than synchronous is a big asset for you. When differet parts of your program can take their own time rather than halt everything makes your application more flexible. Every time something is fetched over the internet it should be with a asynchronous call. As a coding prinsiple thinking for example that a HTTP request is a unreliable reguest and it should not interfere with the running of the program. Asnhronity should be thought to work bit like recursive calls.</p>
  </section>
  <section id ="geonames.js">
  <code>
const Soup = imports.gi.Soup;

function getWeather(station, callback) {
  //some weather
  var session = new Soup.SessionAsync();
  //TODO: Change username to global username instead of personal
  var request = Soup.Message.new('GET', 'http://api.geonames.org/weatherIcaoJSON?ICAO=' + station + '&username=ihmissuski');
  //http://www.geonames.org/export/JSON-webservices.html
  session.queue_message(request, function(session, message) {
    // This function will be run when the HTTP request completes. May be a long time
    if (message.status_code !== 200) {
      // Try again later
      return;
    }
    // Request was OK
    var weatherJSON = request.response_body.data;
    //TODO: parse metar ourselves as geonames is too optimistic
    var weather = JSON.parse(weatherJSON);
    callback(weather);
  });
}

function getIcon(weather){
  //is there any interesting weather?
  switch (weather.weatherObservation.weatherCondition){
  case "drizzle":
  case "light showers rain":
  case "light rain":
    return "weather-showers-scattered.svg";
  case "rain":
    return "weather-showers.svg";
  case "snow": 
  case "snow grains":
    return "weather-snow.svg"; 
  }
  // If not, then we check for clouds
  switch (weather.weatherObservation.clouds){
    case "few clouds":
    case "scattered clouds":
      return "weather-few-clouds.svg";
    case "clear sky":
      return "weather-clear.svg"
    case "broken clouds":
    case "overcast":
      return "weather-overcast.svg";
  }
  return "weather-fog.svg";
}  
  </code>
  <p>Running untill you have all the autotools files ready. :

  $ GJS_PATH=`pwd` gjs weather

  use this command on terminal while developing your modules. When calling your program in this manner it knows where to find your custom JSlibraries.
  </p>
  </section>

</page>

